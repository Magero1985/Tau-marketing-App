<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tau Global Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #2d3748;
        }

        .admin-header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-title {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .stat-icon.pending {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        }

        .stat-icon.approved {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-icon.rejected {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #718096;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 14px 28px;
            border: none;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .products-grid {
            display: grid;
            gap: 2rem;
        }

        .product-admin-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 2rem;
            align-items: center;
            transition: all 0.3s;
        }

        .product-admin-card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .product-admin-image {
            width: 200px;
            height: 150px;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            overflow: hidden;
        }

        .product-admin-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-admin-info {
            flex: 1;
        }

        .product-admin-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .product-admin-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #718096;
            font-size: 0.9rem;
        }

        .product-admin-description {
            color: #718096;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .product-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge.pending {
            background: #FFA500;
            color: white;
        }

        .badge.approved {
            background: #11998e;
            color: white;
        }

        .badge.rejected {
            background: #ff6b6b;
            color: white;
        }

        .product-admin-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-approve {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
        }

        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .users-table {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.2rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .users-table td {
            padding: 1.2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .users-table tr:hover {
            background: #f7fafc;
        }

        .role-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .role-seller {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .role-marketeer {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .role-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .empty-state {
            background: white;
            border-radius: 20px;
            padding: 5rem 2rem;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .empty-state h3 {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #718096;
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            width: 90%;
            padding: 3rem;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            cursor: pointer;
            color: #cbd5e0;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #2d3748;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 700;
            color: #2d3748;
        }

        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
        }

        @media (max-width: 1024px) {
            .product-admin-card {
                grid-template-columns: 1fr;
            }

            .product-admin-actions {
                flex-direction: row;
            }

            .users-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-title">üîê Admin Panel - Tau Global Marketplace</div>
        <div class="admin-user">
            <button onclick="returnToMainApp()" class="btn btn-view" style="margin-right: 1rem; padding: 10px 20px;">
                üè† Back to Main App
            </button>
            <div class="admin-avatar">üë§</div>
            <div>
                <div style="font-weight: 700; font-size: 1.05rem;" id="adminName">Admin User</div>
                <div style="font-size: 0.85rem; color: #718096;">Super Administrator</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon pending">‚è≥</div>
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon approved">‚úÖ</div>
                <div class="stat-number" id="approvedCount">0</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon rejected">‚ùå</div>
                <div class="stat-number" id="rejectedCount">0</div>
                <div class="stat-label">Rejected</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon users">üë•</div>
                <div class="stat-number" id="usersCount">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showTab('pending')">‚è≥ Pending Products</button>
            <button class="tab-btn" onclick="showTab('approved')">‚úÖ Approved Products</button>
            <button class="tab-btn" onclick="showTab('rejected')">‚ùå Rejected Products</button>
            <button class="tab-btn" onclick="showTab('users')">üë• Users Management</button>
            <button class="tab-btn" onclick="showTab('staff')">üëî Staff Members</button>
            <button class="tab-btn" onclick="showTab('chats')">üí¨ Chat Messages</button>
        </div>

        <!-- Pending Products Tab -->
        <div id="pending" class="tab-content active">
            <div class="products-grid" id="pendingProducts">
                <div class="loading">Loading pending products...</div>
            </div>
        </div>

        <!-- Approved Products Tab -->
        <div id="approved" class="tab-content">
            <div class="products-grid" id="approvedProducts">
                <div class="loading">Loading approved products...</div>
            </div>
        </div>

        <!-- Rejected Products Tab -->
        <div id="rejected" class="tab-content">
            <div class="products-grid" id="rejectedProducts">
                <div class="loading">Loading rejected products...</div>
            </div>
        </div>

        <!-- Users Management Tab -->
        <div id="users" class="tab-content">
            <div class="users-table" id="usersTable">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Points</th>
                            <th>Products</th>
                            <th>Referrals</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8" style="text-align: center; padding: 3rem;">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Staff Members Tab -->
        <div id="staff" class="tab-content">
            <div style="background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 2rem; font-size: 1.8rem;">üëî Add New Staff Member</h2>
                <form id="addStaffForm" onsubmit="addStaffMember(event)">
                    <div class="form-group">
                        <label>Staff Email *</label>
                        <input type="email" name="staffEmail" required style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label>Staff Name *</label>
                        <input type="text" name="staffName" required style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="staffRole" required style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                            <option value="moderator">Moderator</option>
                            <option value="admin">Admin</option>
                            <option value="super_admin">Super Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-approve" style="width: 100%; padding: 16px; font-size: 1.1rem;">Add Staff Member ‚úÖ</button>
                </form>
            </div>

            <div class="users-table" id="staffTable">
                <table>
                    <thead>
                        <tr>
                            <th>Staff ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Added On</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 3rem;">Loading staff members...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chat Messages Tab -->
        <div id="chats" class="tab-content">
            <div style="background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom: 2rem; font-size: 1.8rem;">üí¨ Platform Chat Messages</h2>
                <p style="color: #718096; margin-bottom: 2rem;">Monitor and respond to user messages</p>
                <div id="chatMessagesContainer">
                    <p style="text-align: center; padding: 3rem; color: #a0aec0;">Loading chat messages...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('rejectModal')">&times;</span>
            <h2 style="margin-bottom: 2rem; font-size: 1.8rem;">‚ùå Reject Product</h2>
            <p style="color: #718096; margin-bottom: 1.5rem;">Please provide a reason for rejecting this product:</p>
            <div class="form-group">
                <label>Rejection Reason *</label>
                <textarea id="rejectReason" placeholder="Enter detailed reason for rejection..."></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-reject" style="flex: 1;" onclick="confirmReject()">Confirm Rejection</button>
                <button class="btn" style="flex: 1; background: #e2e8f0; color: #2d3748;" onclick="closeModal('rejectModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close-modal" onclick="closeModal('productDetailsModal')">&times;</span>
            <div id="productDetailsContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, updateDoc, doc, deleteDoc, orderBy, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAaUOObFv8KU6KSYC7Uj9c2ELPjbdu-JX0",
            authDomain: "tau-marketplace.firebaseapp.com",
            projectId: "tau-marketplace",
            storageBucket: "tau-marketplace.firebasestorage.app",
            messagingSenderId: "692166197354",
            appId: "1:692166197354:web:b002dd1283f4b247a68a13"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseServices = { auth, db };
        window.currentRejectProductId = null;

        // Load all data on startup
        loadDashboardStats();
        loadProducts('pending');
        loadProducts('approved');
        loadProducts('rejected');
        loadUsers();
        loadStaff();

        async function loadDashboardStats() {
            try {
                const productsSnapshot = await getDocs(collection(db, 'products'));
                const usersSnapshot = await getDocs(collection(db, 'users'));

                let pending = 0, approved = 0, rejected = 0;

                productsSnapshot.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'pending') pending++;
                    else if (status === 'approved') approved++;
                    else if (status === 'rejected') rejected++;
                });

                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('rejectedCount').textContent = rejected;
                document.getElementById('usersCount').textContent = usersSnapshot.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadProducts(status) {
            const container = document.getElementById(`${status}Products`);
            container.innerHTML = '<div class="loading">Loading products...</div>';

            try {
                const q = query(
                    collection(db, 'products'),
                    where('status', '==', status),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No ${status} products</h3>
                            <p>There are currently no products with ${status} status.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        container.innerHTML += createProductCard(product, doc.id, status);
                    });
                }
            } catch (error) {
                console.error(`Error loading ${status} products:`, error);
                container.innerHTML = `<div class="empty-state"><h3>Error loading products</h3><p>${error.message}</p></div>`;
            }
        }

        function createProductCard(product, id, status) {
            const icons = { physical: 'üì¶', service: 'üíº', app: 'üì±', website: 'üåê', software: 'üíª', value: 'üíé' };
            const icon = icons[product.category] || 'üì¶';

            const statusBadge = status === 'pending' ? 
                '<span class="badge pending">‚è≥ Pending Review</span>' :
                status === 'approved' ?
                '<span class="badge approved">‚úÖ Approved</span>' :
                '<span class="badge rejected">‚ùå Rejected</span>';

            const actions = status === 'pending' ? `
                <button class="btn btn-view" onclick="viewProductDetails('${id}')">üëÅÔ∏è View</button>
                <button class="btn btn-approve" onclick="approveProduct('${id}')">‚úÖ Approve</button>
                <button class="btn btn-reject" onclick="showRejectModal('${id}')">‚ùå Reject</button>
                <button class="btn btn-delete" onclick="deleteProduct('${id}')">üóëÔ∏è Delete</button>
            ` : status === 'approved' ? `
                <button class="btn btn-view" onclick="viewProductDetails('${id}')">üëÅÔ∏è View</button>
                <button class="btn btn-reject" onclick="showRejectModal('${id}')">‚ùå Unapprove</button>
                <button class="btn btn-delete" onclick="deleteProduct('${id}')">üóëÔ∏è Delete</button>
            ` : `
                <button class="btn btn-view" onclick="viewProductDetails('${id}')">üëÅÔ∏è View</button>
                <button class="btn btn-approve" onclick="approveProduct('${id}')">‚úÖ Approve</button>
                <button class="btn btn-delete" onclick="deleteProduct('${id}')">üóëÔ∏è Delete</button>
            `;

            return `
                <div class="product-admin-card">
                    <div class="product-admin-image">
                        ${product.imageURL ? 
                            `<img src="${product.imageURL}" alt="${product.name}">` : 
                            `<span>${icon}</span>`
                        }
                    </div>
                    <div class="product-admin-info">
                        <h3 class="product-admin-title">${product.name}</h3>
                        <div class="product-admin-meta">
                            <span class="meta-item">üìÇ ${product.category}</span>
                            <span class="meta-item">üí∞ $${product.price}</span>
                            <span class="meta-item">üì¶ Stock: ${product.stock}</span>
                            <span class="meta-item">üë§ ${product.userEmail}</span>
                        </div>
                        <p class="product-admin-description">${product.description}</p>
                        <div class="product-badges">
                            ${statusBadge}
                            ${product.productUrl ? '<span class="badge" style="background: #4facfe; color: white;">üîó Has URL</span>' : ''}
                        </div>
                    </div>
                    <div class="product-admin-actions">
                        ${actions}
                    </div>
                </div>
            `;
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem;">Loading users...</td></tr>';

            try {
                const snapshot = await getDocs(collection(db, 'users'));

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem;">No users found</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const role = user.role || 'user';
                        const roleBadge = role === 'admin' ? 
                            '<span class="role-badge role-admin">üîê Admin</span>' :
                            role === 'marketeer' ?
                            '<span class="role-badge role-marketeer">üì¢ Marketeer</span>' :
                            role === 'seller' ?
                            '<span class="role-badge role-seller">üì¶ Seller</span>' :
                            '<span class="role-badge" style="background: #e2e8f0; color: #2d3748;">üë§ User</span>';

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-family: monospace; font-size: 0.85rem;">${doc.id.substring(0, 8)}...</td>
                                <td>${user.email}</td>
                                <td>${roleBadge}</td>
                                <td style="font-weight: 700; color: #667eea;">${user.points || 0} iKb</td>
                                <td>${user.products || 0}</td>
                                <td>${user.referrals || 0}</td>
                                <td style="font-size: 0.85rem;">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td>
                                <td>
                                    <button class="btn btn-view" style="padding: 8px 16px; font-size: 0.85rem;" onclick="viewUserDetails('${doc.id}')">View</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem; color: #ff6b6b;">Error loading users</td></tr>';
            }
        }

        async function loadStaff() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem;">Loading staff...</td></tr>';

            try {
                const q = query(collection(db, 'staff'), orderBy('addedAt', 'desc'));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem;">No staff members found</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const staff = doc.data();
                        const roleBadge = staff.role === 'super_admin' ?
                            '<span class="role-badge role-admin">üîê Super Admin</span>' :
                            staff.role === 'admin' ?
                            '<span class="role-badge role-admin">üëî Admin</span>' :
                            '<span class="role-badge" style="background: #4facfe; color: white;">üëÆ Moderator</span>';

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-family: monospace; font-size: 0.85rem;">${doc.id.substring(0, 8)}...</td>
                                <td style="font-weight: 700;">${staff.name}</td>
                                <td>${staff.email}</td>
                                <td>${roleBadge}</td>
                                <td style="font-size: 0.85rem;">${new Date(staff.addedAt).toLocaleDateString()}</td>
                                <td><span class="badge approved">Active</span></td>
                                <td>
                                    <button class="btn btn-delete" style="padding: 8px 16px; font-size: 0.85rem;" onclick="removeStaff('${doc.id}')">Remove</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading staff:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem; color: #ff6b6b;">Error loading staff</td></tr>';
            }
        }

        window.approveProduct = async function(productId) {
            if (!confirm('Are you sure you want to approve this product?')) return;

            try {
                const productDoc = await getDoc(doc(db, 'products', productId));
                const productData = productDoc.data();

                await updateDoc(doc(db, 'products', productId), {
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: 'admin',
                    stage: 8,
                    trackingStage: 'live'
                });

                // Generate tracking code for seller
                const trackingCode = `TAU-${productId.substring(0, 8).toUpperCase()}-${Date.now().toString().substring(5)}`;
                
                await updateDoc(doc(db, 'users', productData.userId), {
                    trackingCode: trackingCode,
                    sellerBadge: true,
                    lastApproval: new Date().toISOString()
                });

                // Send notification (you can integrate email service here)
                await addDoc(collection(db, 'notifications'), {
                    userId: productData.userId,
                    type: 'approval',
                    title: 'üéâ Congratulations! Product Approved',
                    message: `Your product "${productData.name}" has been approved and is now live on Tau Global Marketplace!\n\n‚úÖ Status: APPROVED\nüéØ Tracking Code: ${trackingCode}\nüöÄ Your product is now visible to millions of potential customers\nüí∞ Start earning from sales and referrals\n\nThank you for being part of our marketplace family!`,
                    productId: productId,
                    read: false,
                    createdAt: new Date().toISOString()
                });

                alert('‚úÖ Product approved successfully!\n\nüéâ Seller has been notified\nüè∑Ô∏è Tracking code generated\n‚≠ê Seller badge awarded');
                loadDashboardStats();
                loadProducts('pending');
                loadProducts('approved');
            } catch (error) {
                alert('‚ùå Error approving product: ' + error.message);
            }
        };

        window.confirmReject = async function() {
            const reason = document.getElementById('rejectReason').value.trim();
            
            if (!reason) {
                alert('Please provide a rejection reason');
                return;
            }

            try {
                const productDoc = await getDoc(doc(db, 'products', window.currentRejectProductId));
                const productData = productDoc.data();

                await updateDoc(doc(db, 'products', window.currentRejectProductId), {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: 'admin',
                    rejectionReason: reason,
                    stage: 4,
                    trackingStage: 'failed'
                });

                // Send notification
                await addDoc(collection(db, 'notifications'), {
                    userId: productData.userId,
                    type: 'rejection',
                    title: '‚ùå Product Submission Update',
                    message: `Your product "${productData.name}" requires revision.\n\n‚ùå Status: NEEDS REVISION\n\nüìù Reason:\n${reason}\n\nüí° What to do next:\n‚Ä¢ Review the feedback above\n‚Ä¢ Make necessary changes\n‚Ä¢ Resubmit your product\n\nWe're here to help! Contact support if you need assistance.`,
                    productId: window.currentRejectProductId,
                    read: false,
                    createdAt: new Date().toISOString()
                });

                alert('‚úÖ Product marked for revision!\n\nüìß Seller has been notified with detailed feedback');
                closeModal('rejectModal');
                document.getElementById('rejectReason').value = '';
                loadDashboardStats();
                loadProducts('pending');
                loadProducts('approved');
                loadProducts('rejected');
            } catch (error) {
                alert('‚ùå Error processing rejection: ' + error.message);
            }
        };

        window.deleteProduct = async function(productId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to permanently delete this product? This action cannot be undone!')) return;

            try {
                await deleteDoc(doc(db, 'products', productId));
                alert('‚úÖ Product deleted successfully!');
                loadDashboardStats();
                loadProducts('pending');
                loadProducts('approved');
                loadProducts('rejected');
            } catch (error) {
                alert('‚ùå Error deleting product: ' + error.message);
            }
        };

        window.viewProductDetails = async function(productId) {
            try {
                const productDoc = await getDoc(doc(db, 'products', productId));
                if (!productDoc.exists()) {
                    alert('Product not found');
                    return;
                }

                const product = productDoc.data();
                const icons = { physical: 'üì¶', service: 'üíº', app: 'üì±', website: 'üåê', software: 'üíª', value: 'üíé' };

                document.getElementById('productDetailsContent').innerHTML = `
                    <h2 style="margin-bottom: 2rem; font-size: 1.8rem;">${product.name}</h2>
                    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="width: 300px; height: 225px; border-radius: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 5rem; overflow: hidden;">
                            ${product.imageURL ? `<img src="${product.imageURL}" style="width: 100%; height: 100%; object-fit: cover;">` : icons[product.category] || 'üì¶'}
                        </div>
                        <div>
                            <p style="margin-bottom: 1rem;"><strong>Category:</strong> ${product.category}</p>
                            <p style="margin-bottom: 1rem;"><strong>Price:</strong> $${product.price}</p>
                            <p style="margin-bottom: 1rem;"><strong>Stock:</strong> ${product.stock}</p>
                            <p style="margin-bottom: 1rem;"><strong>Shipping:</strong> ${product.shipping}</p>
                            <p style="margin-bottom: 1rem;"><strong>Seller:</strong> ${product.userEmail}</p>
                            <p style="margin-bottom: 1rem;"><strong>Contact:</strong> ${product.contactEmail}</p>
                            ${product.contactPhone ? `<p style="margin-bottom: 1rem;"><strong>Phone:</strong> ${product.contactPhone}</p>` : ''}
                            ${product.productUrl ? `<p style="margin-bottom: 1rem;"><strong>URL:</strong> <a href="${product.productUrl}" target="_blank">${product.productUrl}</a></p>` : ''}
                        </div>
                    </div>
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Description:</h3>
                        <p style="line-height: 1.8; color: #718096;">${product.description}</p>
                    </div>
                    ${product.tags ? `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Tags:</h3>
                            <p style="color: #718096;">${product.tags}</p>
                        </div>
                    ` : ''}
                    <div>
                        <h3 style="margin-bottom: 1rem;">Status:</h3>
                        <p style="font-weight: 700; color: ${product.status === 'approved' ? '#11998e' : product.status === 'rejected' ? '#ff6b6b' : '#FFA500'}; font-size: 1.2rem; text-transform: uppercase;">${product.status}</p>
                        ${product.rejectionReason ? `<p style="margin-top: 0.5rem; color: #ff6b6b;"><strong>Rejection Reason:</strong> ${product.rejectionReason}</p>` : ''}
                    </div>
                `;

                showModal('productDetailsModal');
            } catch (error) {
                alert('Error loading product details: ' + error.message);
            }
        };

        window.viewUserDetails = async function(userId) {
            alert('User details view - Coming soon!\n\nThis will show:\n‚Ä¢ Complete user profile\n‚Ä¢ All products\n‚Ä¢ Referral network\n‚Ä¢ Transaction history\n‚Ä¢ Points breakdown');
        };

        window.addStaffMember = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const staffId = `staff_${Date.now()}`;
                const staffEmail = formData.get('staffEmail');
                const staffName = formData.get('staffName');
                const staffRole = formData.get('staffRole');

                await setDoc(doc(db, 'staff', staffId), {
                    email: staffEmail,
                    name: staffName,
                    role: staffRole,
                    addedAt: new Date().toISOString(),
                    addedBy: 'super_admin',
                    status: 'active'
                });

                // Send welcome notification
                const roleDisplay = staffRole === 'super_admin' ? 'Super Admin' : staffRole === 'admin' ? 'Admin' : 'Moderator';
                await addDoc(collection(db, 'notifications'), {
                    email: staffEmail,
                    type: 'staff_welcome',
                    title: 'üéâ Welcome to Tau Global Marketplace Team!',
                    message: `Congratulations ${staffName}!\n\nYou have been added as ${roleDisplay} to the Tau Global Marketplace admin team.\n\nüîê Your Role: ${roleDisplay}\nüìß Email: ${staffEmail}\nüìÖ Added: ${new Date().toLocaleDateString()}\n\nüëî Your Responsibilities:\n${staffRole === 'super_admin' ? '‚Ä¢ Full system access\n‚Ä¢ Manage all staff members\n‚Ä¢ Platform configuration' : staffRole === 'admin' ? '‚Ä¢ Review and approve products\n‚Ä¢ Manage users\n‚Ä¢ Handle support tickets' : '‚Ä¢ Review product submissions\n‚Ä¢ Monitor chat messages\n‚Ä¢ Basic user support'}\n\nüöÄ Login to the admin panel to get started!\n\nWelcome aboard!`,
                    read: false,
                    createdAt: new Date().toISOString()
                });

                alert(`‚úÖ Staff member added successfully!\n\nüë§ ${staffName}\nüìß ${staffEmail}\nüëî Role: ${roleDisplay}\n\nüéâ Welcome notification sent!`);
                e.target.reset();
                loadStaff();
            } catch (error) {
                alert('‚ùå Error adding staff member: ' + error.message);
            }
        };

        window.removeStaff = async function(staffId) {
            if (!confirm('Are you sure you want to remove this staff member?')) return;

            try {
                await deleteDoc(doc(db, 'staff', staffId));
                alert('‚úÖ Staff member removed successfully!');
                loadStaff();
            } catch (error) {
                alert('‚ùå Error removing staff member: ' + error.message);
            }
        };

        window.loadDashboardStats = loadDashboardStats;
        window.loadProducts = loadProducts;
    </script>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function returnToMainApp() {
            // Close current window and return to main app
            if (window.opener) {
                window.close();
            } else {
                // If not opened in new window, navigate back
                window.location.href = 'index.html'; // Change to your main app filename
            }
        }

        window.showTab = showTab;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.returnToMainApp = returnToMainApp;
    </script>
</body>
</html>
