<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tau Africa Market Search</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .pending-uploads {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .upload-item img {
            max-width: 150px;
            border-radius: 8px;
            margin-right: 1rem;
        }
        
        .upload-content {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-approve { background: #11998e; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-code { background: #667eea; color: white; }
        
        .stage-selector {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            resize: vertical;
            min-height: 80px;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>üõ†Ô∏è Admin Dashboard</h1>
        <p>Tau Africa Market Search</p>
    </div>

    <div class="admin-container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="pendingCount">0</h3>
                <p>Pending Uploads</p>
            </div>
            <div class="stat-card">
                <h3 id="approvedCount">0</h3>
                <p>Approved Items</p>
            </div>
            <div class="stat-card">
                <h3 id="liveCount">0</h3>
                <p>Live on Marketplace</p>
            </div>
            <div class="stat-card">
                <h3 id="marketeersCount">0</h3>
                <p>Active Marketeers</p>
            </div>
        </div>

        <div class="pending-uploads">
            <h2 style="margin-bottom: 1.5rem;">Pending Verification</h2>
            <div id="uploadsList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is admin
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Verify admin status
            const adminDoc = await getDoc(doc(db, 'admins', user.uid));
            if (!adminDoc.exists() || adminDoc.data().role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }

            loadAdminData();
        });

        async function loadAdminData() {
            // Load statistics
            const uploadsSnapshot = await getDocs(collection(db, 'uploads'));
            const marketplaceSnapshot = await getDocs(collection(db, 'marketplace'));
            const marketeersSnapshot = await getDocs(collection(db, 'marketeers'));

            let pendingCount = 0;
            let approvedCount = 0;
            let liveCount = 0;

            uploadsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.status === 'submitted' || data.status === 'pending') {
                    pendingCount++;
                } else if (data.status === 'approved') {
                    approvedCount++;
                }
            });

            marketplaceSnapshot.forEach(doc => {
                if (doc.data().status === 'live') liveCount++;
            });

            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('approvedCount').textContent = approvedCount;
            document.getElementById('liveCount').textContent = liveCount;
            document.getElementById('marketeersCount').textContent = marketeersSnapshot.size;

            // Load pending uploads
            loadPendingUploads();
        }

        async function loadPendingUploads() {
            const q = query(collection(db, 'uploads'), where('status', 'in', ['submitted', 'pending']));
            const snapshot = await getDocs(q);

            const uploadsList = document.getElementById('uploadsList');
            uploadsList.innerHTML = '';

            if (snapshot.empty) {
                uploadsList.innerHTML = '<p style="text-align: center; color: #999;">No pending uploads</p>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const uploadItem = createUploadItem(doc.id, data);
                uploadsList.innerHTML += uploadItem;
            });
        }

        function createUploadItem(id, data) {
            return `
                <div class="upload-item" id="upload_${id}">
                    <div class="upload-content">
                        <img src="${data.imageURL || 'https://via.placeholder.com/150'}" alt="${data.itemName}">
                        <div style="flex: 1;">
                            <h3>${data.itemName}</h3>
                            <p><strong>Category:</strong> ${data.category}</p>
                            <p><strong>Price:</strong> $${data.price}</p>
                            <p><strong>Seller:</strong> ${data.userEmail}</p>
                            <p><strong>Description:</strong> ${data.description}</p>
                            <p><strong>URL:</strong> <a href="${data.url}" target="_blank">${data.url}</a></p>
                            <p><strong>Submitted:</strong> ${new Date(data.createdAt?.toDate()).toLocaleString()}</p>
                            <p><strong>Current Stage:</strong> ${data.stage || 1}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label><strong>Update Stage:</strong></label>
                        <select class="stage-selector" id="stage_${id}">
                            <option value="1" ${data.stage === 1 ? 'selected' : ''}>1 - Submitted</option>
                            <option value="2" ${data.stage === 2 ? 'selected' : ''}>2 - Verification</option>
                            <option value="3" ${data.stage === 3 ? 'selected' : ''}>3 - Validation</option>
                            <option value="4" ${data.stage === 4 ? 'selected' : ''}>4 - Review (Pass/Fail)</option>
                            <option value="5" ${data.stage === 5 ? 'selected' : ''}>5 - Generate Code</option>
                            <option value="6" ${data.stage === 6 ? 'selected' : ''}>6 - Uploaded</option>
                            <option value="7" ${data.stage === 7 ? 'selected' : ''}>7 - Marketing Active</option>
                            <option value="8" ${data.stage === 8 ? 'selected' : ''}>8 - Live & Earning</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label><strong>Admin Notes:</strong></label>
                        <textarea id="notes_${id}" placeholder="Add notes or rejection reason...">${data.adminNotes || ''}</textarea>
                    </div>
                    
                    <div class="upload-actions">
                        <button class="btn btn-approve" onclick="approveUpload('${id}')">‚úÖ Approve</button>
                        <button class="btn btn-reject" onclick="rejectUpload('${id}')">‚ùå Reject</button>
                        <button class="btn btn-code" onclick="generateCode('${id}')">üîë Generate Code</button>
                        <button class="btn btn-code" onclick="publishToMarketplace('${id}')">üöÄ Publish Live</button>
                    </div>
                </div>
            `;
        }

        window.approveUpload = async function(uploadId) {
            const stage = parseInt(document.getElementById(`stage_${uploadId}`).value);
            const notes = document.getElementById(`notes_${uploadId}`).value;

            try {
                await updateDoc(doc(db, 'uploads', uploadId), {
                    status: 'approved',
                    stage: stage,
                    adminNotes: notes,
                    updatedAt: new Date()
                });

                alert('Upload approved! Email notification sent to seller.');
                loadAdminData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.rejectUpload = async function(uploadId) {
            const notes = document.getElementById(`notes_${uploadId}`).value;

            if (!notes) {
                alert('Please provide a rejection reason in the notes field.');
                return;
            }

            try {
                await updateDoc(doc(db, 'uploads', uploadId), {
                    status: 'rejected',
                    stage: 4,
                    rejectionReason: notes,
                    adminNotes: notes,
                    updatedAt: new Date()
                });

                alert('Upload rejected. Email notification sent to seller.');
                loadAdminData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.generateCode = async function(uploadId) {
            const code = 'TAU' + Math.random().toString(36).substring(2, 10).toUpperCase();

            try {
                await updateDoc(doc(db, 'uploads', uploadId), {
                    verificationCode: code,
                    stage: 5,
                    status: 'code_generated',
                    updatedAt: new Date()
                });

                alert(`Verification code generated: ${code}\n\nEmail sent to seller with code.`);
                loadAdminData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.publishToMarketplace = async function(uploadId) {
            try {
                const uploadDoc = await getDoc(doc(db, 'uploads', uploadId));
                const uploadData = uploadDoc.data();

                // Add to marketplace collection
                await addDoc(collection(db, 'marketplace'), {
                    ...uploadData,
                    status: 'live',
                    stage: 8,
                    views: 0,
                    sales: 0,
                    rating: 5,
                    publishedAt: new Date()
                });

                // Update upload status
                await updateDoc(doc(db, 'uploads', uploadId), {
                    status: 'live',
                    stage: 8,
                    publishedAt: new Date()
                });

                alert('‚úÖ Item published to marketplace!\n\nAI marketing campaign activated.');
                loadAdminData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };
    </script>
</body>
</html>
```

## Quick Admin Setup Steps

### 1. Create Admin User in Firestore

Go to Firebase Console ‚Üí Firestore ‚Üí Create Collection:

**Collection:** `admins`
**Document ID:** Your Firebase Auth UID
**Fields:**
```json
{
  "role": "admin",
  "email": "admin@tauafricamarket.com",
  "name": "Admin Name",
  "createdAt": "2025-01-25T00:00:00Z"
}
```

### 2. Get Your Firebase Auth UID

```javascript
// Run this in browser console after logging in:
firebase.auth().currentUser.uid
// Copy the UID and use it as document ID in admins collection
```

### 3. Access Admin Panel

Navigate to: `https://yoursite.com/admin.html`

Only users in the `admins` collection can access this page.

## Admin Capabilities

‚úÖ View all pending uploads
‚úÖ Approve/Reject submissions
‚úÖ Update verification stages
‚úÖ Generate verification codes
‚úÖ Publish items to marketplace
‚úÖ Add admin notes
‚úÖ View statistics dashboard
‚úÖ Track marketeer activity

## Email Notification Triggers

Emails are automatically sent when:
- New upload submitted ‚Üí Admin notified
- Upload approved ‚Üí Seller notified
- Code generated ‚Üí Seller receives code
- Upload rejected ‚Üí Seller informed with reason
- Item published ‚Üí Seller congratulated

## Security Best Practices

1. **Never share admin credentials**
2. **Use strong passwords**
3. **Enable 2FA on Firebase account**
4. **Regularly audit admin actions**
5. **Keep Firebase rules updated**
6. **Monitor suspicious activity**
7. **Backup Firestore regularly**

## Troubleshooting

**Problem:** Can't access admin panel
- Check if UID is in admins collection
- Verify role is set to "admin"
- Clear browser cache

**Problem:** Email notifications not working
- Check Cloud Functions are deployed
- Verify email credentials
- Check function logs in Firebase Console

**Problem:** Images not uploading
- Check Storage rules
- Verify file size limits
- Check browser console for errors
